<h1 align="center">
    Marauderâ€™s Map Backend
</h1>

<p align="center">
    <a href="https://fastapi.tiangolo.com" target="_blank">
        <img src="https://img.shields.io/badge/FastAPI-005571?style=for-the-badge&logo=fastapi" alt="Built with FastAPI">
    </a>
</p>


## Development setup

> Assumes Python version `^3.10`

1. Install [`Poetry`](https://python-poetry.org/) for Python package management. The following should work for Linux, macOS and Windows (WSL):
```
curl -sSL https://install.python-poetry.org | python3 -
```
2. Install project dependencies
```
poetry install
```
> if Poetry starts complaining about `psycopg2-binary`, simply follow the next step to enter the shell and run `pip install` manually
> ```
> pip install psycopg2-binary
> ```
3. Enter Poetry virtual environment (venv)
```
poetry shell
```
> if the above command returns `Virtual environment already activated`, use the following instead
>```
>source $(poetry env info --path)/bin/activate
>```
4. Install [`pre-commit`](https://pre-commit.com/) hooks
```
pre-commit install
```

### Environment variables
A template `base.env` file is included inside `/maraudersmap`, which can be copied to a local, gitignored `.env` file. These values are only used for local development (e.g. a local database connection string).

### Poetry integration with VS Code
If you're using VS Code, you need to tell it where your Poetry virtualenv is located
1. `Open Workspace Settings (JSON)` via the command palette (`Ctrl+Shift+P`). This will open `.vscode/settings.json`.
2. Add the following settings
```json
{
    "python.pythonPath": "<Poetry Virtualenv Path>",
    "python.defaultInterpreterPath": "<Poetry Virtualenv Executable>"
}
```
where `<Poetry Virtualenv Path>` and `<Poetry Virtualenv Executable>` need to be replaced with your Poetry env values. These can be found with the following command
```
poetry env info
```
This will display something like
```
...

Virtualenv
Python:         3.10.4
Implementation: CPython
Path:           /home/mathias/.cache/pypoetry/virtualenvs/maraudersmap-ljAqK4qE-py3.10
Executable:     /home/mathias/.cache/pypoetry/virtualenvs/maraudersmap-ljAqK4qE-py3.10/bin/python
Valid:          True

...
```

3. Back in your Workspace Settings, replace `<Poetry Virtualenv Path>` with the value of `Path` and `<Poetry Virtualenv Executable>` with the value of `Executable`. For the above example, it will look like this
```json
{
    "python.pythonPath": "/home/mathias/.cache/pypoetry/virtualenvs/maraudersmap-ljAqK4qE-py3.10",
    "python.defaultInterpreterPath": "/home/mathias/.cache/pypoetry/virtualenvs/maraudersmap-ljAqK4qE-py3.10/bin/python"
}
```

## Start database
A quick approach for setting up a PostgreSQL database is to run the official Docker image. Just make sure you have [installed Docker](https://docs.docker.com/get-docker/) first.
```
docker run -p 5432:5432 -e POSTGRES_PASSWORD=password -v maraudersmap_psql:/var/lib/postgresql/data postgres:14.5
```
> the above command might require `sudo`

> you could choose any password for the database, but make sure to update the connection string accordingly

> the above command creates a named volume `maraudersmap_psql`, which will persist the database data between image restarts


## Run backend
### First time
We need to specify the database connection string in a `.env` file located inside `/maraudersmap`. You can use the `base.env` template as a starting point.
```sh
cd maraudersmap
cp base.env .env
```

### Every time

1. Make sure to [apply any new database migrations](#apply-migrations)
2. Start server
```bash
cd maraudersmap
uvicorn main:app --host 0.0.0.0 --reload
```
> must be run from `/maraudersmap` directory to recognize `.env`
> using `--host 0.0.0.0` seems to be required for accessing the backend via the public IP address

## Database Migrations

Any changes to the database schema need to be documented in an Alembic migration file (`maraudersmap/alembic/versions`), which is used to upgrade tables in currently running databases. 

### Create migrations
> make sure the database is running

These migration files can be autogenerated with the following command (inside `maraudersmap/`)
```
alembic revision --autogenerate -m "<Some descriptive title>"
```

### Apply migrations
> make sure the database is running

A database can be upgraded to the latest version with the following command (inside `maraudersmap/`)
```
alembic upgrade head
```